<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient-LLM Chatbot Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        textarea {
            width: 100%;
            height: 100px;
            border-radius: 15px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            border: none;
            padding: 10px;
        }
        #chatbox {
            background-color: #f0f0f0;
            border-radius: 15px;
            padding: 10px;
            height: 600px;
            overflow-y: auto;
            margin-bottom: 20px;
            box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.1);
        }
        .message {
            margin: 10px 0;
            display: flex;
            align-items: center;
        }
        .message.user {
            justify-content: flex-end;
            text-align: right;
        }
        .message.bot {
            justify-content: flex-start;
            text-align: left;
        }
        .message img {
            max-width: 100px;
            border-radius: 10px;
            margin-left: 10px;
        }
        .message-content {
            max-width: 70%;
            padding: 10px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.1);
        }
        #apikey-section {
            display: flex;
            justify-content: space-between;
        }
        #apiForm {
            display: flex;
            margin-bottom: 20px;
        }
        #apiForm input {
            flex: 1;
            margin-right: 10px;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        #patient-icon {
            width: 30px;
            height: 30px;
            margin-right: 10px;
        }
        #imagePreview {
            margin-top: 10px;
        }
        .attach-icon {
            cursor: pointer;
            margin-left: 10px;
        }
        #imageInput {
            display: none;
        }
        #summary {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 10px;
        }
        /* Progress Bar Styles */
        .progress-bar {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 25px;
            margin-bottom: 20px;
        }
        .progress-bar-fill {
            height: 25px;
            width: 0;
            background-color: #4caf50;
            border-radius: 25px;
            transition: width 1s ease-in-out;
        }
        #decision-tree {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
        }
    </style>
</head>
<body>

<h1>Patient-LLM</h1>

<div id="apikey-section">
    <div id="apiForm">
        <input type="text" id="apikey" placeholder="Enter your OpenAI API Key">
        <button id="apikeyBtn">Submit</button>
    </div>
</div>

<div id="chatbox"></div>

<textarea id="userInput" placeholder="Type your message..."></textarea>
<img src="https://cdn-icons-png.freepik.com/512/74/74741.png" alt="Attach Image" class="attach-icon" id="attachBtn" width="30">
<input type="file" id="imageInput" accept="image/*">

<div id="imagePreview"></div>

<div id="summary"></div>

<div class="progress-bar">
    <div class="progress-bar-fill" id="progress-bar-fill"></div>
</div>

<div id="decision-tree"></div>

<script>
    let conversationHistory = [
        {
            role: "system",
            content: `You are a 79-year-old male patient with the following characteristics:
            - Presenting with shortness of breath during moderate exertion
            - Slightly productive cough
            - History of heavy smoking for 25 years
            - Vitals: heart rate 89/min, respiratory rate 27/min, blood pressure 120/90 mm Hg
            - Physical exam: increased resonance to percussion, decreased breath sounds, crackles at the lung base
            - Chest radiography shows signs of pulmonary hyperinflation
            - Spirometry results: FEV1 48%, FVC 85%, FEV1/FVC ratio 56%

            Respond to the doctor's questions based on this information. If asked about something not mentioned here, respond with "I don't know" or "No". Do not provide any medical analysis or diagnosis.`
        }
    ];
    let apiKey = "";
    let imageFile = null;
    let imageBase64 = "";
    let numTurns = 0;
    let diagnosisMade = false;
    const maxTurns = 10;
    const correctDiagnosis = "COPD";

    async function sendMessage() {
        const userInput = document.getElementById('userInput').value;
        const chatbox = document.getElementById('chatbox');

        if (!apiKey) {
            alert('Please enter your API key');
            return;
        }

        if (!userInput.trim() && !imageFile) {
            return;
        }

        const userMessage = document.createElement('div');
        userMessage.className = 'message user';

        const userContent = document.createElement('div');
        userContent.className = 'message-content';
        userContent.textContent = userInput;
        userMessage.appendChild(userContent);

        if (imageFile) {
            const imgElement = document.createElement('img');
            imgElement.src = URL.createObjectURL(imageFile);
            userMessage.appendChild(imgElement);
        }

        chatbox.appendChild(userMessage);
        chatbox.scrollTop = chatbox.scrollHeight;

        if (userInput.trim()) {
            conversationHistory.push({ role: "user", content: userInput });
        }

        document.getElementById('userInput').value = '';
        document.getElementById('imagePreview').innerHTML = '';

        // Check if the user doctor made the correct diagnosis
        if (userInput.toLowerCase().includes("copd")) {
            diagnosisMade = true;
            endConversation();
            return; // Stop further processing since the conversation should end
        }

        // Increment the turn counter
        numTurns++;

        if (userInput.trim() || imageBase64) {
            try {
                let messages = [...conversationHistory];

                if (imageBase64) {
                    messages.push({
                        role: "user",
                        content: [
                            { type: "text", text: userInput.trim() || "Please analyze this image." },
                            { type: "image_url", image_url: { url: `data:image/jpeg;base64,${imageBase64}` } }
                        ]
                    });
                } else {
                    messages.push({ role: "user", content: userInput.trim() });
                }

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: messages,
                        max_tokens: 300
                    })
                });

                const data = await response.json();
                let botResponse = data.choices[0].message.content;

                // Check if the correct diagnosis was made in the bot's response
                if (botResponse.toLowerCase().includes("copd")) {
                    diagnosisMade = true;
                    botResponse += "\nCorrect diagnosis made! Ending the conversation.";
                }

                const botMessage = document.createElement('div');
                botMessage.className = 'message bot';

                const icon = document.createElement('img');
                icon.src = 'https://img.icons8.com/color/48/000000/patient-oxygen-mask.png';
                icon.id = 'patient-icon';

                const botContent = document.createElement('div');
                botContent.className = 'message-content';
                botContent.textContent = botResponse;

                botMessage.appendChild(icon);
                botMessage.appendChild(botContent);
                chatbox.appendChild(botMessage);
                chatbox.scrollTop = chatbox.scrollHeight;

                conversationHistory.push({ role: "assistant", content: botResponse });

                if (diagnosisMade || numTurns >= maxTurns) {
                    endConversation();
                }

                // Reset image-related variables
                imageFile = null;
                imageBase64 = "";
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while connecting to the API');
            }
        }
    }

    function endConversation() {
        const summaryDiv = document.getElementById('summary');
        summaryDiv.innerHTML = '';

        const summaryTitle = document.createElement('h3');
        summaryTitle.textContent = 'Conversation Summary';
        summaryDiv.appendChild(summaryTitle);

        const numTurnsText = document.createElement('p');
        numTurnsText.textContent = `Number of turns: ${numTurns}`;
        summaryDiv.appendChild(numTurnsText);

        if (diagnosisMade) {
            const successText = document.createElement('p');
            successText.textContent = "The doctor made the correct diagnosis (COPD).";
            summaryDiv.appendChild(successText);
        } else {
            const failureText = document.createElement('p');
            failureText.textContent = `The doctor did not make the correct diagnosis within ${maxTurns} turns. The correct diagnosis was COPD.`;
            summaryDiv.appendChild(failureText);
        }

        // Trigger the progress bar to fill
        fillProgressBar();

        // Display the decision-making process as a tree
        displayDecisionTree();
    }

    function fillProgressBar() {
        const progressBarFill = document.getElementById('progress-bar-fill');
        let width = 0;
        const interval = setInterval(() => {
            if (width >= 100) {
                clearInterval(interval);
            } else {
                width++;
                progressBarFill.style.width = width + '%';
            }
        }, 10); // Fills the bar in 1 second
    }

    function displayDecisionTree() {
        const decisionTreeDiv = document.getElementById('decision-tree');
        decisionTreeDiv.innerHTML = `
            <h3>Doctor's Decision-Making Process</h3>
            <ul>
                <li>Step 1: Asked about symptoms (shortness of breath, cough).</li>
                <li>Step 2: Collected lab results (spirometry, radiography).</li>
                <li>Step 3: Analyzed the results (FEV1, FVC ratios).</li>
                <li>Step 4: Diagnosed the condition as COPD.</li>
            </ul>
        `;
    }

    document.getElementById('apikeyBtn').addEventListener('click', function() {
        apiKey = document.getElementById('apikey').value;
        if (apiKey) {
            document.getElementById('apikey-section').style.display = 'none';
        } else {
            alert('Please enter a valid API key.');
        }
    });

    document.getElementById('userInput').addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    });

    document.getElementById('attachBtn').addEventListener('click', function() {
        document.getElementById('imageInput').click();
    });

    document.getElementById('imageInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const imagePreview = document.getElementById('imagePreview');
            imageFile = file;

            const imgElement = document.createElement('img');
            imgElement.src = URL.createObjectURL(file);
            imgElement.style.maxWidth = '100px';
            imgElement.style.borderRadius = '10px';
            imagePreview.innerHTML = '';
            imagePreview.appendChild(imgElement);

            // Convert image to base64
            const reader = new FileReader();
            reader.onloadend = function() {
                imageBase64 = reader.result.split(',')[1];
            }
            reader.readAsDataURL(file);
        }
    });
</script>

</body>
</html>
