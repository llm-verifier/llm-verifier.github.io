---
layout: default
title: Medical Annotation Tool
---

<h1>Medical Annotation Tool</h1>

<div id="annotation-container">
  <h2>Medical Problem</h2>
  <p id="medical-problem"></p>
  
  <h2>Options</h2>
  <ul id="options"></ul>
  
  <h2>LLM Reasoning</h2>
  <div id="llm-reasoning" contenteditable="true"></div>
  
  <div id="annotation-buttons">
    <button onclick="handleAnnotation('strikethrough')">Strikethrough</button>
    <button onclick="handleAnnotation('hallucination')">Hallucination</button>
    <button onclick="handleAnnotation('overinterpretation')">Overinterpretation</button>
    <button onclick="handleAnnotation('misdiagnosis')">Misdiagnosis</button>
    <button onclick="handleAnnotation('correct')">Correct</button>
    <button onclick="handleComment()">Add Comment</button>
  </div>
  
  <button onclick="handleSave()">Save Annotations</button>
  
  <div id="navigation-buttons">
    <button id="prev-btn" onclick="prevProblem()">Previous</button>
    <button id="next-btn" onclick="nextProblem()">Next</button>
  </div>
</div>

<script>
  let problems = [];
  let currentProblemIndex = 0;
  let annotations = [];

  // Load the JSONL file and parse each problem
  async function loadProblems() {
    const response = await fetch('test.jsonl'); // Assumes the JSONL file is hosted or accessible via a relative path
    const text = await response.text();
    problems = text.trim().split('\n').map(line => JSON.parse(line));
    displayProblem(currentProblemIndex);
  }

  // Display the current problem and its options
  function displayProblem(index) {
    const problem = problems[index];
    document.getElementById('medical-problem').textContent = problem.question;
    const options = document.getElementById('options');
    options.innerHTML = ''; // Clear previous options
    
    Object.keys(problem.options).forEach(key => {
      const optionItem = document.createElement('li');
      optionItem.textContent = `${key}: ${problem.options[key]}`;
      options.appendChild(optionItem);
    });
    
    document.getElementById('llm-reasoning').textContent = generateLLMReasoning(problem); // This will use your LLM reasoning logic
  }

  // Mock function to generate LLM Reasoning (replace with actual LLM output)
  function generateLLMReasoning(problem) {
    return `Based on the symptoms and options, the most likely answer is ${problem.answer}.`;
  }

  // Handle annotations (as in original version)
  const annotationStyles = {
    strikethrough: { style: 'text-decoration: line-through;', color: '#FF0000' },
    hallucination: { style: 'background-color: #FFA500;', color: '#FFA500' },
    overinterpretation: { style: 'background-color: #FFFF00;', color: '#FFFF00' },
    misdiagnosis: { style: 'background-color: #FF69B4;', color: '#FF69B4' },
    correct: { style: 'background-color: #90EE90;', color: '#90EE90' }
  };

  function getSelectionOffset() {
    const reasoningText = document.getElementById('llm-reasoning').textContent;
    const selection = window.getSelection();
    const selectedText = selection.toString();
    
    const start = reasoningText.indexOf(selectedText);
    const end = start + selectedText.length;
    
    return { start, end, text: selectedText };
  }

  function handleAnnotation(type) {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;

    const range = selection.getRangeAt(0);
    const span = document.createElement('span');
    span.style = annotationStyles[type].style;
    span.className = `annotation ${type}`;
    range.surroundContents(span);

    const { start, end, text } = getSelectionOffset();
    annotations.push({ category: type, start, end, text });
  }

  function handleComment() {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;

    const range = selection.getRangeAt(0);
    const comment = prompt("Enter your comment:");
    if (comment) {
      const span = document.createElement('span');
      span.style.backgroundColor = '#00FFFF';
      span.className = 'annotation comment';
      span.title = comment;
      range.surroundContents(span);

      const start = getNodeOffset(range.startContainer, range.startOffset);
      const end = getNodeOffset(range.endContainer, range.endOffset);
      annotations.push({ category: 'comment', start, end, text: range.toString(), comment });
    }
  }

  function handleSave() {
    const problem = document.getElementById('medical-problem').textContent;
    const reasoning = document.getElementById('llm-reasoning').textContent;

    const annotationData = {
      input: problem,
      output: reasoning,
      annotations: annotations
    };

    const jsonData = JSON.stringify(annotationData, null, 2);

    const blob = new Blob([jsonData], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `annotations_problem_${currentProblemIndex + 1}.json`;
    link.click();
  }

  // Navigation functions
  function prevProblem() {
    if (currentProblemIndex > 0) {
      currentProblemIndex--;
      displayProblem(currentProblemIndex);
    }
  }

  function nextProblem() {
    if (currentProblemIndex < problems.length - 1) {
      currentProblemIndex++;
      displayProblem(currentProblemIndex);
    }
  }

  // Initialize by loading problems
  loadProblems();

</script>

<style>
  #annotation-container {
    max-width: 800px;
    margin: 0 auto;
  }
  #llm-reasoning {
    border: 1px solid #ccc;
    padding: 10px;
    margin-bottom: 10px;
    line-height: 1.6;
  }
  #annotation-buttons {
    margin-bottom: 10px;
  }
  button {
    margin-right: 10px;
    margin-bottom: 5px;
  }
  .annotation {
    padding: 2px 0;
  }
  .comment {
    text-decoration: underline;
    text-decoration-style: wavy;
    text-decoration-color: #00FFFF;
  }
  #navigation-buttons {
    margin-top: 20px;
  }
</style>
