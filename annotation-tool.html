---
layout: default
title: Medical Annotation Tool
---

<h1>Medical Annotation Tool</h1>

<div id="annotation-container">
  <h2>Medical Problem</h2>
  <p id="medical-problem"></p>
  
  <h2>LLM Reasoning</h2>
  <div id="llm-reasoning" contenteditable="true"></div>
  
  <div id="annotation-buttons">
    <button onclick="handleAnnotation('strikethrough')">Strikethrough</button>
    <button onclick="handleAnnotation('hallucination')">Hallucination</button>
    <button onclick="handleAnnotation('overinterpretation')">Overinterpretation</button>
    <button onclick="handleAnnotation('misdiagnosis')">Misdiagnosis</button>
    <button onclick="handleAnnotation('correct')">Correct</button>
    <button onclick="handleComment()">Add Comment</button>
  </div>
  <button onclick="handleSave()">Save Annotations</button>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const problem = "A 79-year-old man presents to the office due to shortness of breath with moderate exertion and a slightly productive cough. He has a medical history of 25 years of heavy smoking. His vitals include: heart rate 89/min, respiratory rate 27/min, and blood pressure 120/90 mm Hg. The physical exam shows increased resonance to percussion, decreased breath sounds, and crackles at the lung base. Chest radiography shows signs of pulmonary hyperinflation. Spirometry shows a forced expiratory volume in the first second (FEV1) of 48%, a forced vital capacity (FVC) of 85%, and an FEV1/FVC ratio of 56%. According to these results, what is the most likely diagnosis?\n(A) Asthma (B) Lymphangioleiomyomatosis (C) Chronic obstructive pulmonary disease (COPD) (D) Bronchiectasis (E) Heart failure";
    
    const llmReasoning = "Based on the patient's symptoms and test results, the most likely diagnosis is Chronic Obstructive Pulmonary Disease (COPD). The patient's history of heavy smoking for 25 years is a significant risk factor for COPD. The shortness of breath with exertion and productive cough are classic symptoms. The physical exam findings of increased resonance to percussion and decreased breath sounds indicate air trapping, which is characteristic of COPD. The spirometry results show an FEV1/FVC ratio of 56%, which meets the criteria for COPD diagnosis. Additionally, the chest X-ray showing pulmonary hyperinflation is consistent with COPD. The crackles at the lung base suggest the presence of pneumonia, which is a common complication in COPD patients. The elevated respiratory rate of 27/min indicates that the patient is in respiratory distress, likely due to an acute exacerbation of COPD.";

    // Display the problem and reasoning on the page
    document.getElementById('medical-problem').textContent = problem;
    document.getElementById('llm-reasoning').textContent = llmReasoning;
  });

  const annotationStyles = {
    strikethrough: { style: 'text-decoration: line-through;', color: '#FF0000' },
    hallucination: { style: 'background-color: #FFA500;', color: '#FFA500' },
    overinterpretation: { style: 'background-color: #FFFF00;', color: '#FFFF00' },
    misdiagnosis: { style: 'background-color: #FF69B4;', color: '#FF69B4' },
    correct: { style: 'background-color: #90EE90;', color: '#90EE90' }
  };

  let annotations = [];

  function getSelectionOffset() {
    const reasoningText = document.getElementById('llm-reasoning').textContent; // Get the full text content
    const selection = window.getSelection();
    const selectedText = selection.toString(); // Get the selected text
  
    const start = reasoningText.indexOf(selectedText); // Find the starting index
    const end = start + selectedText.length; // Calculate the end index
  
    return { start, end, text: selectedText };
  }


  function handleAnnotation(type) {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;
  
    const range = selection.getRangeAt(0);
    const span = document.createElement('span');
    span.style = annotationStyles[type].style;
    span.className = `annotation ${type}`;
    range.surroundContents(span);
  
    // Get the start and end positions of the selection using the revised function
    const { start, end, text } = getSelectionOffset();
  
    // Push the annotation with accurate positions
    annotations.push({ category: type, start, end, text });
  }


  function getNodeOffset(node, offset) {
    let chars = 0;
    while (node && node !== document.getElementById('llm-reasoning')) {
      if (node.previousSibling) {
        node = node.previousSibling;
        chars += node.textContent.length;
      } else {
        node = node.parentNode;
      }
    }
    return chars + offset;
  }

  function handleComment() {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;

    const range = selection.getRangeAt(0);
    const comment = prompt("Enter your comment:");
    if (comment) {
      const span = document.createElement('span');
      span.style.backgroundColor = '#00FFFF';
      span.className = 'annotation comment';
      span.title = comment;
      range.surroundContents(span);

      const start = getNodeOffset(range.startContainer, range.startOffset);
      const end = getNodeOffset(range.endContainer, range.endOffset);

      annotations.push({ category: 'comment', start, end, text: range.toString(), comment });
    }
  }

  function handleSave() {
    const problem = document.getElementById('medical-problem').textContent;
    const reasoning = document.getElementById('llm-reasoning').textContent;

    const annotationData = {
      input: problem,
      output: reasoning,
      annotations: annotations
    };

    const jsonData = JSON.stringify(annotationData, null, 2);
    
    // Create a blob for the JSON file and trigger a download
    const blob = new Blob([jsonData], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'annotations.json';
    link.click();
  }
</script>


<style>
  #annotation-container {
    max-width: 800px;
    margin: 0 auto;
  }
  #llm-reasoning {
    border: 1px solid #ccc;
    padding: 10px;
    margin-bottom: 10px;
    line-height: 1.6;
  }
  #annotation-buttons {
    margin-bottom: 10px;
  }
  button {
    margin-right: 10px;
    margin-bottom: 5px;
  }
  .annotation {
    padding: 2px 0;
  }
  .comment {
    text-decoration: underline;
    text-decoration-style: wavy;
    text-decoration-color: #00FFFF;
  }
</style>
