---
layout: default
title: Medical Annotation Tool
---

<h1>Medical Annotation Tool</h1>

<!-- Step 1: API Key Input -->
<div id="apiPrompt">
    <div id="apiForm">
        <h2>Please enter your OpenAI API key to proceed:</h2>
        <input type="text" id="apikey" placeholder="Enter API key">
        <button id="apikeyBtn">Submit</button>
    </div>
</div>

<!-- Problems and Annotations (hidden initially) -->
<div id="annotation-tool" style="display:none;">
    <div id="problems-container"></div>
    <button onclick="handleSaveAll()">Save All Annotations</button>
</div>

<script>
// Variables to store problems and annotations
let problems = [];
let annotations = [];
let apiKey = "";

// Debugging: Ensure this block runs after clicking the API key button
document.getElementById('apikeyBtn').addEventListener('click', function() {
    apiKey = document.getElementById('apikey').value;
    console.log('API Key entered:', apiKey); // Debugging: Check if the API key is captured

    if (apiKey) {
        console.log('Valid API key, proceeding to show annotation tool.');
        document.getElementById('apiPrompt').style.display = 'none';
        document.getElementById('annotation-tool').style.display = 'block';
        loadProblems();
    } else {
        alert('Please enter a valid API key.');
        console.log('No API key provided, stopping.');
    }
});

// Load JSONL file and display problems
async function loadProblems() {
    console.log('Loading problems...'); // Debugging: Ensure problem loading starts
    try {
        const response = await fetch('test.jsonl'); // Assumes the JSONL file is hosted or accessible via a relative path
        const text = await response.text();
        problems = text.trim().split('\n').map((line, index) => ({ ...JSON.parse(line), index }));
        displayProblems();
    } catch (error) {
        console.error('Error loading problems:', error); // Debugging: Log errors
        alert('Failed to load problems. Please check the JSONL file.');
    }
}

// Display all problems on the page
function displayProblems() {
    console.log('Displaying problems...'); // Debugging: Ensure problems are displayed
    const problemsContainer = document.getElementById('problems-container');
    problemsContainer.innerHTML = ''; // Clear previous content
    
    problems.forEach(problem => {
        const problemDiv = document.createElement('div');
        problemDiv.classList.add('problem-block');
        problemDiv.innerHTML = `
            <h2>Problem ${problem.index + 1}</h2>
            <p>${problem.question}</p>
            <h3>Options</h3>
            <ul>
              ${Object.keys(problem.options).map(key => `<li>${key}: ${problem.options[key]}</li>`).join('')}
            </ul>
            <h3>LLM Reasoning</h3>
            <div id="llm-reasoning-${problem.index}" class="llm-reasoning" contenteditable="true">Loading reasoning...</div>
            <div id="annotation-buttons-${problem.index}">
              <button onclick="handleAnnotation(${problem.index}, 'strikethrough')">Strikethrough</button>
              <button onclick="handleAnnotation(${problem.index}, 'hallucination')">Hallucination</button>
              <button onclick="handleAnnotation(${problem.index}, 'overinterpretation')">Overinterpretation</button>
              <button onclick="handleAnnotation(${problem.index}, 'misdiagnosis')">Misdiagnosis</button>
              <button onclick="handleAnnotation(${problem.index}, 'correct')">Correct</button>
              <button onclick="handleComment(${problem.index})">Add Comment</button>
            </div>
        `;
        problemsContainer.appendChild(problemDiv);
        
        // Generate LLM Reasoning for each problem
        generateLLMReasoning(problem, apiKey, problem.index);
    });
}

// Function to generate LLM reasoning (this integrates with the GPT-4o-mini model)
async function generateLLMReasoning(problem, apiKey, index) {
    const apiUrl = "https://api.openai.com/v1/completions";
    const headers = {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`
    };

    const body = JSON.stringify({
        model: "gpt-4o-mini",
        prompt: `Problem: ${problem.question}\nAnswer: ${problem.answer}\nGenerate a detailed reasoning that supports this answer.`,
        max_tokens: 150
    });

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: headers,
            body: body
        });

        if (!response.ok) {
            throw new Error('OpenAI API request failed');
        }

        const data = await response.json();
        console.log('Received response for problem', index); // Debugging: Check if API response is received
        document.getElementById(`llm-reasoning-${index}`).textContent = data.choices[0].text.trim();
    } catch (error) {
        console.error(`Error generating reasoning for problem ${index}:`, error); // Debugging: Log error if reasoning fails
        document.getElementById(`llm-reasoning-${index}`).textContent = "Error generating reasoning.";
    }
}
</script>

<style>
  .problem-block {
    border-bottom: 1px solid #ccc;
    margin-bottom: 20px;
  }
  .llm-reasoning {
    border: 1px solid #ccc;
    padding: 10px;
    margin-bottom: 10px;
    line-height: 1.6;
  }
  button {
    margin-right: 10px;
    margin-bottom: 5px;
  }
  .annotation {
    padding: 2px 0;
  }
  .comment {
    text-decoration: underline;
    text-decoration-style: wavy;
    text-decoration-color: #00FFFF;
  }
</style>
